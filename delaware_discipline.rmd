---
title: "Black students are disproprotionately disciplined in Delaware"
editor_options: 
  markdown: 
    wrap: 72
  chunk_output_type: inline
---

Get started, loading & cleaning the data.

```{r setup, include=FALSE}
# Turn off scientific notation
options(scipen=999) 
library(tidyverse)
library(janitor)
library(magrittr) # use magrittr if you want to replicate the function of the tidyverse |> character in vscode or a similar program - this code uses the |> character a lot
library(dplyr)
library(ggthemes)
library(stringr)
library(purrr)

# Remove comment from the below read_csv line as necessary.
delaware_discipline <- read_csv("/Users/joellevtov/Library/CloudStorage/GoogleDrive-levtov@terpmail.umd.edu/My Drive/Journalism/delawarediscipline/delaware_student_discipline_raw.csv") |> 
    clean_names() |> 
    select(!geography) #the geography column reads either "All Students" or, for redacted rows, "NA" - so this will ignore the column
delaware_discipline$sub_group <- str_replace(delaware_discipline$sub_group, regex("Asian", ignore_case = TRUE), "Asian American") 
delaware_discipline$category <- str_replace(delaware_discipline$category, regex("Out-of-School Suspension, No CDAP Placement", ignore_case = TRUE), "Out-of-School Suspension without CDAP Placement")

# The raw data has two different phrases that mean the same thing - "Out-of-School Suspension, No CDAP Placement" and "Out-of-School Suspension without CDAP Placement". For clarity, I replaced the latter with the former.
delaware_pop <- read_csv("/Users/joellevtov/Downloads/Student_Enrollment_20240216.csv") |> 
    clean_names()
delaware_pop$grade <- str_replace(delaware_pop$grade, regex("Twelfth", ignore_case=TRUE), "12th Grade")
delaware_pop$sub_group <- str_replace(delaware_pop$sub_group, regex("Asian", ignore_case = TRUE), "Asian American")
```

Let's make the racial labels easier to type.

```{r}
race_categories <- as.data.frame(unique(na.omit(delaware_discipline$race))) 
colnames(race_categories)[1] <- "race"
race_categories <- as.data.frame(race_categories) |> 
    filter(race != "All Students") #removed the line that had "All Students" as a race
name_hisp <- race_categories[1,1]
name_white <- race_categories[2,1]
name_native_am <- race_categories[3,1]
name_black <- race_categories[4,1]
name_asian_am <- race_categories[5,1]
name_multi_racial <- race_categories[6,1]
name_hawaiian_pi <- race_categories[7,1]
print_var_name_and_value <- function(x) {
  # Capture and print the variable name
  var_name <- deparse(substitute(x))
  
  # Capture and print the variable value
  var_value <- eval(substitute(x))
  
  # Combine into a data frame for pretty printing
  result_df <- data.frame(
    variable_name = var_name,
    variable_value = as.character(var_value),
    stringsAsFactors = FALSE  # Avoid factors for strings
  )
  
  print(result_df)
}

# Run each line individually to make sure that the variables represent the correct string - this will be critical later on.
print_var_name_and_value(name_hisp)
print_var_name_and_value(name_white)
print_var_name_and_value(name_native_am)
print_var_name_and_value(name_black)
print_var_name_and_value(name_asian_am)
print_var_name_and_value(name_multi_racial)
print_var_name_and_value(name_hawaiian_pi)
```

Let's break down the <delaware_discipline> dataframe. <school_year>
shows what school year we are addressing <district_code> is a column we
will ignore, but it shows the number code of each district. The one we
want is 0, the state of Delaware. <district> shows in words the name of
each district. <school_code> shows the number code of each school.
<organization> shows the school name <race> shows what race the
statistics address <special_demo> is a more clear version of the
<sub_group> column. It shows what subgroup the statistics contained in
the row are for <sub_group> shows the above in a more complicated form
-- i.e. instead of reading "ESL students", it might read
"Hispanic/Latino/1st Grade/Out-of-School Suspension with CDAP/ESL
students." This would be helpful, but it doesn't list all the statuses,
e.g. what district one is looking at <category> displays what type of
discipline was applied - in-school discipline, out-of-school discipline,
expulsion, etc. <rowstatus> shows whether or not a row has been ommitted
out of privacy concerns - if the pool of students is small enough, it
would be possible to identify which students were disciplined, in theory
<students> shows the number of STUDENTS who were disciplined with
<category> <enrollment> shows the numer of students who fit into a
certain <status> <pct_enrollment> shows what percent of the student body
the studeents in <sub_group> make up <incidents> shows the number of
times <status> was applied - e.g the number of times a student got
in-school suspension, NOT the number of students that got in-school
suspension <avg_duration> shows how many days students in <sub_group>
were suspended for on average

That dataframe is helpful, but is hard to query for population counts --
taking the median of the number of Hispanic 2nd graders is hard to do
because the enrollment numbers are repeated 2-5 times with each
discipline <category>. Luckily, the state offers another spreadsheet
with exclusively enrollment numbers. race num_enrolled num_disciplined
num_incidents per_capita_disciplines length Hispanic/Latino x x x x x
Native American x x x x x African American x x x x x White x x x x x
Asian American x x x x x Multi-Racial x x x x x Native Hawaiian/Pacific
Islander x x x x x

<num_enrolled> is the average number of students in a grade across all
eight years <num_disciplined> is the average number of students that
have faced discipline in each category <num_of_incidents> is the average
number of incidents (i.e. NOT the number of students)
<per_capita_disciplines> is the average number of students disciplined,
i.e. num_students_disciplined/enrollement <length> is the average length
of a discipline measure in days

Now we can start calculating. First, we calculate how many students of
each race there are overall -- e.g. on average, how many white 10th
graders there were in Delaware. Taking the median here so that we don't
overcount the number of students like we'd do if we were to sum or get
an average thrown off by outliers like we would get with the median. Big
fluctuations in enrollment are certainly an interesting story, but not
the one we are focusing on here.

```{r}
# this function calculates the average number of students of each race, gender, district and sub_group. Need to keep in mind that Delaware has redacted some rows for CDAP privacy reasons.
median_student_num <- function(.data) { 
    filtered_race_data <- .data |> 
        ungroup() |> 
        group_by(race, grade, gender, district_code, sub_group) |> 
        summarize(students = median(na.omit(students)))
    filtered_race_data$school_year <- NA
return(filtered_race_data)
}
filtered_race_data <- median_student_num(delaware_pop)
    
delaware_pop_copy <- delaware_pop |> 
    full_join(filtered_race_data, join_by(grade, sub_group, students, race, district_code, school_year, gender))
```

The process_race_data function is a one-stop shop to calculating
everything we could want. One can specify the following parameters: -
District Code (this argument is mandatory) - Race - Grade - Gender -
Discipline type (i.e. in-school suspension, out-of-school suspension,
expulsion)

If interested in all students in a particular category, e.g. the average
number of students of all races, write "all" (any capitalization), leave
the argument out, or write "NULL."

```{r}
process_race_data <- function(pop_df, discipline_df, dis_code, race_name, grade_query, gender_query, disc_type) {
    library(stringr)
    library(tidyverse)

    filter_incidents <- function(.data, dis_code, race_name = NULL, grade_query = NULL, gender_query = NULL, disc_type = NULL) {
    # Start with filtering district_code as it's applied regardless
    filtered <- .data |> 
        filter(district_code == dis_code) 
    
    # Apply filter for race_name. Default to "All Students" if "all" or NULL
    if (is.null(race_name) || tolower(race_name) == "all") {
        filtered <- filtered |>  filter(race == "All Students")
    } else {
        filtered <- filtered |> filter(race == race_name) |> filter(sub_group == race_name)
    }
    
    # Apply filter for grade_query. Use str_detect for partial matches. Default to "All Students" if "all" or NULL
    if (is.null(grade_query) || tolower(grade_query) == "all") {
        filtered <- filtered |>  filter(grade == "All Students")
    } else {
        filtered <- filtered |>  filter(str_detect(grade, regex(grade_query, ignore_case = TRUE)))
    }
    
    # Apply filter for gender_query. Default to "All Students" if "all" or NULL
    if (is.null(gender_query) || tolower(gender_query) == "all") {
        filtered <- filtered |> filter(gender == "All Students")
    } else {
        filtered <- filtered |> filter(gender == gender_query)
    }

    # Apply filter for disc_type if provided and not "all". No "All Students" default for discipline type as it doesn't apply
    if (!is.null(disc_type) && tolower(disc_type) != "all") {
        filtered <- filtered |> filter(category == disc_type)
    } 
    
    filtered <- filtered |> 
    summarize(num_incidents=median(na.omit(incidents)), num_disc_students=median(na.omit(students)))

    return(filtered)
    }

length_of_discipline <- function(.data, dis_code, race_name = NULL, grade_query = NULL, gender_query = NULL, disc_type = NULL) {
    # Start with filtering district_code as it's applied regardless
    filtered <- .data |> 
        filter(district_code == dis_code) 
    
    # Apply filter for race_name. Default to "All Students" if "all" or NULL
    if (is.null(race_name) || tolower(race_name) == "all") {
        filtered <- filtered |>  filter(race == "All Students")
    } else {
        filtered <- filtered |> filter(race == race_name) |> filter(sub_group == race_name)
    }
    # Apply filter for grade_query. Use str_detect for partial matches. Default to "All Students" if "all" or NULL
    if (is.null(grade_query) || tolower(grade_query) == "all") {
        filtered <- filtered |>  filter(grade == "All Students")
    } else {
        filtered <- filtered |>  filter(str_detect(grade, regex(grade_query, ignore_case = TRUE)))
    }
    # Apply filter for gender_query. Default to "All Students" if "all" or NULL
    if (is.null(gender_query) || tolower(gender_query) == "all") {
        filtered <- filtered |> filter(gender == "All Students")
    } else {
        filtered <- filtered |> filter(gender == gender_query)
    }
    # Apply filter for disc_type if provided and not "all". No "All Students" default for discipline type as it doesn't apply
    if (!is.null(disc_type) && tolower(disc_type) != "all") {
        filtered <- filtered |> filter(category == disc_type)
    } 
    filtered <- filtered |> 
    summarize(avg_length=median(na.omit(avg_duration)))
    return(filtered)
}
    
# this function finds the average number of students of a certain race
find_num_race <- function(.data, dis_code, race_name = NULL, grade_query = NULL, gender_query = NULL, disc_type = NULL) { 
        filtered <- .data |> # .data takes the population dataframe
            filter(district_code== dis_code)
    if (is.null(race_name) || tolower(race_name) == "all") {
        filtered <- filtered |> filter(race == "All Students")
    } else {
        filtered <- filtered |> filter(race == race_name) |> filter(sub_group == race_name)
    }
        if (is.null(grade_query) || tolower(grade_query) == "all") {
        filtered <- filtered |>  filter(grade == "All Students")
    } else {
        filtered <- filtered |>  filter(str_detect(grade, regex(grade_query, ignore_case = TRUE)))
    }
        if (is.null(gender_query) || tolower(gender_query) == "all") {
        filtered <- filtered |>  filter(gender == "All Students")
    } else {
        filtered <- filtered |>  filter(gender == gender_query)
    }

    filtered <- filtered |> 
        filter(is.na(school_year)) # |> 
                    # select(students)
            return(filtered)
        }

    num_race <- find_num_race(pop_df, dis_code, race_name, grade_query, gender_query)
    # this function calculates the average number of incidents per race
    incidents_per_race <- filter_incidents(discipline_df, dis_code, race_name, grade_query, gender_query, disc_type)
    # this function calculates the average length of a discipline measure
    discipline_length <- length_of_discipline(discipline_df, dis_code, race_name, grade_query, gender_query, disc_type)
    # this joins the dataframes into one
    incidents_per_race$num_students <- num_race$students
    incidents_per_race$length <- discipline_length$avg_length
    # this changes the order of the columns
    incidents_per_race <- relocate(incidents_per_race, num_students, .before = 1)
    # this calculates the per capita rate
    incidents_per_race <- incidents_per_race |> 
        mutate(per_capita = as.numeric(num_incidents) / as.numeric(num_students))
}

# The above functions make our life a lot easier - now we just have to plug in the dataframes, the district code and the race.
hisp_incidents <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hisp, "all", "all", "all") # could also leave out the "all" arguments all together and provide no arguments for grade_query, gender_query, disc_type as they are automatically set to 'null'
print(hisp_incidents)
native_am_incidents <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_native_am, "all", "all", "all") 
print(native_am_incidents)
black_incidents <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_black, "all", "all", "all") 
print(black_incidents)
white_incidents <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_white, "all", "all", "all") 
print(white_incidents)
asian_am_incidents <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_asian_am, "all", "all", "all") 
print(asian_am_incidents)
multi_racial_incidents <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_multi_racial, "all", "all", "all") 
print(multi_racial_incidents)
hawaiian_pi_incidents <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hawaiian_pi, "all", "all", "all") 
print(hawaiian_pi_incidents)
```

A word of caution - make sure asian_am_incidents is NOT 'NA'. The code
seems to be correct but R does not consistently replace "Asian" with
"Asian American" in sub_group, it seems. If it does come up with 'NA'
for asian_am_incidents, try quitting R, re-starting, and re-rerunning
the code that replaces "Asian" with "Asian American" at the top. Now,
we're going to make a graph.

```{r}
overall <- list()
overall <- hisp_incidents |> 
    full_join(native_am_incidents) |> 
    full_join(black_incidents) |> 
    full_join(white_incidents) |> 
    full_join(asian_am_incidents) |> 
    full_join(multi_racial_incidents) |> 
    full_join(hawaiian_pi_incidents) |> 
    mutate(
        race=c(name_hisp, name_native_am, name_black, name_white, name_asian_am, name_multi_racial, name_hawaiian_pi)
    ) |> 
    rename(avg_num_enrolled=num_students) |> 
    rename(avg_per_capita_disciplines=per_capita) |> 
    rename(avg_num_incidents=num_incidents) |> 
    rename(avg_num_disc_students=num_disc_students) |> 
    rename(avg_length=length) 

overall$discipline_type <- "All"
overall <- overall |>  
    relocate(race, .before=avg_num_enrolled) |> 
    relocate(discipline_type, .after=race)
print(overall)

write_csv(overall, "/Users/joellevtov/Library/CloudStorage/GoogleDrive-levtov@terpmail.umd.edu/My Drive/Journalism/delawarediscipline/delaware_discipline_statewide_overall.csv")

overall_graph <- overall |> 
  mutate(race_ordered = fct_reorder(race, avg_per_capita_disciplines)) # Assuming 'race' is the column you want on x-axis

overall_graph <- overall_graph |> 
    ggplot() +
    geom_col(aes(x= race_ordered, y=avg_per_capita_disciplines), fill="darkblue") +
    labs(
        title="Black and multi-racial students are far more likely to face discipline in Delaware.",
        x= "race",
        y="avg"
    ) +
    theme_economist() +
    theme(
    axis.text.x = element_text(angle = 45, hjust=1, vjust=0.9, size=15),  # Adjust text angle, justification, and size
    plot.margin = margin(t = 10, r = 10, b = 40, l = 10, unit = "pt")  # Expand bottom margin
    )
ggsave("overall_discipline_rates_delaware.png", overall_graph)
print(overall_graph)
```

What's clear from this data is that Black and multi-racial students are
far more likely to be disciplined . But do they get more serious
discipline - e.g. out-of-school suspension vs. in-school discipline?
Let's dive deeper into the data. First, let's create some variables -
there are six types of discipline noted in the data - in-school
suspension, out-of-school suspension (with and without CDAP --
"Consortium Discipline Alternative Program" -- used when the student has
been punished through school programs without improving and they
"routinely and seriously disrupt the classroom").

```{r}
name_in_school_sus <- "In-School Suspension" 
name_oos <- "Out-of-School Suspension"
name_oos_wo_cdap <- "Out-of-School Suspension without CDAP Placement"    
name_oos_cdap <- "Out-of-School Suspension with CDAP Placement"   
name_expulsion <-"Expulsion (Permanent Removal from School)"      
```

First, let's tackle in-school suspension.

```{r}
hisp_in_school_sus <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hisp, NULL, NULL, name_in_school_sus)
print(hisp_in_school_sus)
native_am_in_school_sus <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_native_am, NULL, NULL, name_in_school_sus)
print(native_am_in_school_sus)
black_in_school_sus <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_black, NULL, NULL, name_in_school_sus)
print(black_in_school_sus)
white_in_school_sus <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_white, NULL, NULL, name_in_school_sus)
print(white_in_school_sus)
asian_am_in_school_sus <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_asian_am, NULL, NULL, name_in_school_sus)
print(asian_am_in_school_sus)
multi_racial_in_school_sus <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_multi_racial, NULL, NULL, name_in_school_sus)
print(multi_racial_in_school_sus)
hawaiian_pi_in_school_sus <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hawaiian_pi, NULL, NULL, name_in_school_sus)
print(hawaiian_pi_in_school_sus)

in_school_suspensions <- hisp_in_school_sus |> 
    full_join(native_am_in_school_sus) |> 
    full_join(black_in_school_sus) |> 
    full_join(white_in_school_sus) |> 
    full_join(asian_am_in_school_sus) |> 
    full_join(multi_racial_in_school_sus) |> 
    full_join(hawaiian_pi_in_school_sus) |> 
    rename(avg_num_enrolled=num_students) |> 
    rename(avg_per_capita_disciplines=per_capita) |> 
    rename(avg_num_incidents=num_incidents) |> 
    rename(avg_num_disc_students=num_disc_students) |> 
    rename(avg_length=length)
in_school_suspensions$race <- c(name_hisp, name_native_am, name_black, name_white, name_asian_am, name_multi_racial, name_hawaiian_pi) 
in_school_suspensions$discipline_type <- name_in_school_sus
in_school_suspensions <- in_school_suspensions |>  
    relocate(race, .before=avg_num_enrolled) |> 
    relocate(discipline_type, .after=race)
print(in_school_suspensions)

write_csv(in_school_suspensions, "/Users/joellevtov/Library/CloudStorage/GoogleDrive-levtov@terpmail.umd.edu/My Drive/Journalism/delawarediscipline/delaware_discipline_statewide_in_school_suspensions.csv")

in_school_suspensions_graph <- in_school_suspensions |> 
  mutate(race_ordered = fct_reorder(race, avg_per_capita_disciplines)) # Assuming 'race' is the column you want on x-axis

in_school_suspensions_graph <- in_school_suspensions_graph |> 
    ggplot() +
    geom_col(aes(x= race_ordered, y=avg_per_capita_disciplines), fill="darkblue") +
    labs(
        title="Black and multi-racial students are far more likely to face in-school discipline in Delaware.",
        x= "race",
        y="avg"
    ) +
    theme_economist() +
    theme(
    axis.text.x = element_text(angle = 45, hjust=1, vjust=0.9, size=15),  # Adjust text angle, justification, and size
    plot.margin = margin(t = 10, r = 10, b = 40, l = 10, unit = "pt")  # Expand bottom margin
    )
print(in_school_suspensions_graph)
```

Very interesting. Now, let's see about out-of-school suspensions with CDAP.

```{r}
hisp_oos_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hisp, NULL, NULL, name_oos_cdap)
print(hisp_oos_cdap)
native_am_oos_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_native_am, NULL, NULL, name_oos_cdap)
print(native_am_oos_cdap)
black_oos_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_black, NULL, NULL, name_oos_cdap)
print(black_oos_cdap)
white_oos_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_white, NULL, NULL, name_oos_cdap)
print(white_oos_cdap)
asian_am_oos_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_asian_am, NULL, NULL, name_oos_cdap) # this returns na, as there are no rows which document out-of-school suspensions - with or without CDAP for Asian American students. Presumably, that means there were no out-of-school suspensions for all 6,111 Asian students throughout the years. 
print(asian_am_incidents)
multi_racial_oos_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_multi_racial, NULL, NULL, name_oos_cdap)
print(multi_racial_oos_cdap)
hawaiian_pi_oos_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hawaiian_pi, NULL, NULL, name_oos_cdap)
print(hawaiian_pi_oos_cdap)

out_of_school_cdap_suspensions <- hisp_oos_cdap |> 
    full_join(native_am_oos_cdap) |> 
    full_join(black_oos_cdap) |> 
    full_join(white_oos_cdap) |> 
    full_join(asian_am_oos_cdap) |> 
    full_join(multi_racial_oos_cdap) |> 
    full_join(hawaiian_pi_oos_cdap) |> 
    rename(avg_num_enrolled=num_students) |> 
    rename(avg_per_capita_disciplines=per_capita) |> 
    rename(avg_num_incidents=num_incidents) |> 
    rename(avg_num_disc_students=num_disc_students) |> 
    rename(avg_length=length)
out_of_school_cdap_suspensions$race <- c(name_hisp, name_native_am, name_black, name_white, name_asian_am, name_multi_racial, name_hawaiian_pi) 
out_of_school_cdap_suspensions$discipline_type <- name_oos_cdap
out_of_school_cdap_suspensions <- out_of_school_cdap_suspensions |>  
    relocate(race, .before=avg_num_enrolled) |> 
    relocate(discipline_type, .after=race)
print(out_of_school_cdap_suspensions)

# this will transform rows with only 'NA' values so r can sort it without throwing an error.
out_of_school_cdap_suspensions_graph <- out_of_school_cdap_suspensions |> 
  mutate(
      avg_num_incidents = if_else(is.na(avg_num_incidents), 0, avg_num_incidents),
      avg_num_disc_students = if_else(is.na(avg_num_disc_students), 0, avg_num_disc_students),
      avg_length = if_else(is.na(avg_length), 0, avg_length),
      avg_per_capita_disciplines = if_else(is.na(avg_per_capita_disciplines), 0, avg_per_capita_disciplines)
    )

out_of_school_cdap_suspensions_graph <- out_of_school_cdap_suspensions_graph %>%
    mutate(race_ordered = fct_reorder(race, avg_num_disc_students))

out_of_school_cdap_suspensions_graph <- out_of_school_cdap_suspensions_graph |> 
    ggplot() +
    geom_col(aes(x= race_ordered, y=avg_num_disc_students), fill="darkblue") +
    labs(
        title="Black and white students are most likely to face out-of-school discipline without CDAP in Delaware.",
        x= "race",
        y="avg"
    ) +
    theme_economist() +
    theme(
    axis.text.x = element_text(angle = 45, hjust=1, vjust=0.9, size=15),  # Adjust text angle, justification, and size
    plot.margin = margin(t = 10, r = 10, b = 40, l = 10, unit = "pt")  # Expand bottom margin
    )
print(out_of_school_cdap_suspensions_graph)
```

Let's see about out-of-school suspensions without CDAP.

```{r}
hisp_oos_wo_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hisp, NULL, NULL, name_oos_wo_cdap)
native_am_oos_wo_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_native_am, NULL, NULL, name_oos_wo_cdap)
black_oos_wo_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_black, NULL, NULL, name_oos_wo_cdap)
white_oos_wo_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_white, NULL, NULL, name_oos_wo_cdap)
asian_am_oos_wo_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_asian_am, NULL, NULL, name_oos_wo_cdap)
multi_racial_oos_wo_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_multi_racial, NULL, NULL, name_oos_wo_cdap)
hawaiian_pi_oos_wo_cdap <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hawaiian_pi, NULL, NULL, name_oos_wo_cdap)

out_of_school_wo_cdap_suspensions <- hisp_oos_wo_cdap |> 
    full_join(native_am_oos_wo_cdap) |> 
    full_join(black_oos_wo_cdap) |> 
    full_join(white_oos_wo_cdap) |> 
    full_join(asian_am_oos_wo_cdap) |> 
    full_join(multi_racial_oos_wo_cdap) |> 
    full_join(hawaiian_pi_oos_wo_cdap)|> 
    rename(avg_num_enrolled=num_students) |> 
    rename(avg_per_capita_disciplines=per_capita) |> 
    rename(avg_num_incidents=num_incidents) |> 
    rename(avg_num_disc_students=num_disc_students) |> 
    rename(avg_length=length)
out_of_school_wo_cdap_suspensions$race <- c(name_hisp, name_native_am, name_black, name_white, name_asian_am, name_multi_racial, name_hawaiian_pi) 
out_of_school_wo_cdap_suspensions$discipline_type <- name_oos_wo_cdap
out_of_school_wo_cdap_suspensions <- out_of_school_wo_cdap_suspensions |>  
    relocate(race, .before=avg_num_enrolled) |> 
    relocate(discipline_type, .after=race)
print(out_of_school_wo_cdap_suspensions)

write_csv(out_of_school_wo_cdap_suspensions, "/Users/joellevtov/Library/CloudStorage/GoogleDrive-levtov@terpmail.umd.edu/My Drive/Journalism/delawarediscipline/delaware_discipline_statewide_out_of_school_suspensions_WITHOUT_CDAP.csv")

# this will transform any rows with only 'NA' values to 0 so r can sort it without throwing an error.
out_of_school_wo_cdap_suspensions_graph <- out_of_school_wo_cdap_suspensions |> 
  mutate(
      avg_num_incidents = if_else(is.na(avg_num_incidents), 0, avg_num_incidents),
      avg_num_disc_students = if_else(is.na(avg_num_disc_students), 0, avg_num_disc_students),
      avg_length = if_else(is.na(avg_length), 0, avg_length),
      avg_per_capita_disciplines = if_else(is.na(avg_per_capita_disciplines), 0, avg_per_capita_disciplines)
    )

out_of_school_wo_cdap_suspensions_graph <- out_of_school_wo_cdap_suspensions_graph %>%
    mutate(race_ordered = fct_reorder(race, avg_per_capita_disciplines))


out_of_school_wo_cdap_suspensions_graph <- out_of_school_wo_cdap_suspensions_graph |> 
    ggplot() +
    geom_col(aes(x= race_ordered, y=avg_per_capita_disciplines), fill="darkblue") +
    labs(
        title="Black and multi-racial students are most likely to face out-of-school discipline without CDAP in Delaware.",
        x= "race",
        y="avg"
    ) +
    theme_economist() +
    theme(
    axis.text.x = element_text(angle = 45, hjust=1, vjust=0.9, size=15),  # Adjust text angle, justification, and size
    plot.margin = margin(t = 10, r = 10, b = 40, l = 10, unit = "pt")  # Expand bottom margin
    )
print(out_of_school_wo_cdap_suspensions_graph)
```

```{r}
hisp_oos <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hisp, NULL, NULL, name_oos)
native_am_oos <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_native_am, NULL, NULL, name_oos)
black_oos <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_black, NULL, NULL, name_oos)
white_oos <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_white, NULL, NULL, name_oos)
asian_am_oos <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_asian_am, NULL, NULL, name_oos)
multi_racial_oos <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_multi_racial, NULL, NULL, name_oos)
hawaiian_pi_oos <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hawaiian_pi, NULL, NULL, name_oos)

oos <- hisp_oos |> 
    full_join(native_am_oos) |> 
    full_join(black_oos) |> 
    full_join(white_oos) |> 
    full_join(asian_am_oos) |> 
    full_join(multi_racial_oos) |> 
    full_join(hawaiian_pi_oos)|> 
    rename(avg_num_enrolled=num_students) |> 
    rename(avg_per_capita_disciplines=per_capita) |> 
    rename(avg_num_incidents=num_incidents) |> 
    rename(avg_num_disc_students=num_disc_students) |> 
    rename(avg_length=length)
oos$race <- c(name_hisp, name_native_am, name_black, name_white, name_asian_am, name_multi_racial, name_hawaiian_pi) 
oos$discipline_type <- name_oos
oos <- oos |>  
    relocate(race, .before=avg_num_enrolled) |> 
    relocate(discipline_type, .after=race)
print(oos)

write_csv(oos, "/Users/joellevtov/Library/CloudStorage/GoogleDrive-levtov@terpmail.umd.edu/My Drive/Journalism/delawarediscipline/delaware_discipline_statewide_out_of_school_suspensions.csv")

# this will transform any rows with only 'NA' values to 0 so r can sort it without throwing an error.
oos_graph <- oos |> 
  mutate(
      avg_num_incidents = if_else(is.na(avg_num_incidents), 0, avg_num_incidents),
      avg_num_disc_students = if_else(is.na(avg_num_disc_students), 0, avg_num_disc_students),
      avg_length = if_else(is.na(avg_length), 0, avg_length),
      avg_per_capita_disciplines = if_else(is.na(avg_per_capita_disciplines), 0, avg_per_capita_disciplines)
    )

oos_graph <- oos_graph |> 
    mutate(race_ordered = fct_reorder(race, avg_per_capita_disciplines))

oos_graph <- oos_graph |> 
    ggplot() +
    geom_col(aes(x= race_ordered, y=avg_per_capita_disciplines), fill="darkblue") +
    labs(
        title="Black and Native American students are most likely to face out-of-school suspensions in Delaware.",
        x= "race",
        y="avg"
    ) +
    theme_economist() +
    theme(
    axis.text.x = element_text(angle = 45, hjust=1, vjust=0.9, size=15),  # Adjust text angle, justification, and size
    plot.margin = margin(t = 10, r = 10, b = 40, l = 10, unit = "pt")  # Expand bottom margin
    )
print(oos_graph)
```

Below, expulsion data. Note that most data is redacted so there's not a
ton of useful analysis that can be done.

```{r}
hisp_expulsion <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hisp, NULL, NULL, name_expulsion)
native_am_expulsion <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_native_am, NULL, NULL, name_expulsion)
black_expulsion <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_black, NULL, NULL, name_expulsion)
white_expulsion <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_white, NULL, NULL, name_expulsion)
asian_am_expulsion <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_asian_am, NULL, NULL, name_expulsion)
multi_racial_expulsion <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_multi_racial, NULL, NULL, name_expulsion)
hawaiian_pi_expulsion <- process_race_data(delaware_pop_copy, delaware_discipline, 0, name_hawaiian_pi, NULL, NULL, name_expulsion)

expulsions <- hisp_expulsion |> 
    full_join(native_am_expulsion) |> 
    full_join(black_expulsion) |> 
    full_join(white_expulsion) |> 
    full_join(asian_am_expulsion) |> 
    full_join(multi_racial_expulsion) |> 
    full_join(hawaiian_pi_expulsion) |> 
    rename(avg_num_enrolled=num_students) |> 
    rename(avg_per_capita_disciplines=per_capita) |> 
    rename(avg_num_incidents=num_incidents) |> 
    rename(avg_num_disc_students=num_disc_students) |> 
    rename(avg_length=length)
expulsions$race <- c(name_hisp, name_native_am, name_black, name_white, name_asian_am, name_multi_racial, name_hawaiian_pi) 
expulsions$discipline_type <- name_expulsion
expulsions <- expulsions |>  
    relocate(race, .before=avg_num_enrolled) |> 
    relocate(discipline_type, .after=race)
print(expulsions)

# this will transform any rows with only 'NA' values to 0 so r can sort it without throwing an error.
expulsions_graph <- expulsions |> 
  mutate(
      avg_num_incidents = if_else(is.na(avg_num_incidents), 0, avg_num_incidents),
      avg_num_disc_students = if_else(is.na(avg_num_disc_students), 0, avg_num_disc_students),
      avg_length = if_else(is.na(avg_length), 0, avg_length),
      avg_per_capita_disciplines = if_else(is.na(avg_per_capita_disciplines), 0, avg_per_capita_disciplines)
    )
write_csv(expulsions, "/Users/joellevtov/Library/CloudStorage/GoogleDrive-levtov@terpmail.umd.edu/My Drive/Journalism/delawarediscipline/expulsions.csv")

expulsions_graph <- expulsions_graph |> 
  mutate(race_ordered = fct_reorder(race, avg_per_capita_disciplines)) # Assuming 'race' is the column you want on x-axis

expulsions_graph <- expulsions_graph |> 
    ggplot() +
    geom_col(aes(x= race_ordered, y=avg_per_capita_disciplines), fill="darkblue") +
    labs(
        title="Black students are most likely to face expulsions in Delaware.",
        x= "race",
        y="avg"
    ) +
    theme_economist() +
    theme(
    axis.text.x = element_text(angle = 45, hjust=1, vjust=0.9, size=15),  # Adjust text angle, justification, and size
    plot.margin = margin(t = 10, r = 10, b = 40, l = 10, unit = "pt")  # Expand bottom margin
    )
print(expulsions_graph)
```

Black students are consistently the most likely to face discipline. Are
they also more likely to face a longer discipline length?

``` {r}
per_capita_in_school_suspensions <- in_school_suspensions |> select(race, discipline_type, avg_per_capita_disciplines)
print(per_capita_in_school_suspensions)
per_capita_oos <- oos |> select(race, discipline_type, avg_per_capita_disciplines)
print(per_capita_oos)
per_capita_oos_cdap <- out_of_school_cdap_suspensions |>  select(race, discipline_type, avg_per_capita_disciplines)
print(per_capita_oos_cdap)
per_capita_oos_wo_cdap <- out_of_school_wo_cdap_suspensions |>  select(race, discipline_type, avg_per_capita_disciplines)
print(per_capita_oos_wo_cdap)
per_capita_expulsions <- expulsions |> select(race, discipline_type, avg_per_capita_disciplines)
print(per_capita_expulsions)

per_capita_statewide_discipline <- per_capita_in_school_suspensions |> 
    full_join(per_capita_oos) |> 
    full_join(per_capita_oos_cdap) |> 
    full_join(per_capita_oos_wo_cdap) |> 
    full_join(per_capita_expulsions)
print(per_capita_statewide_discipline)

per_capita_statewide_discipline <- per_capita_statewide_discipline |> 
  mutate(
      avg_per_capita_disciplines = if_else(is.na(avg_per_capita_disciplines), 0, avg_per_capita_disciplines)
    )

per_capita_statewide_graph <- ggplot(per_capita_statewide_discipline, aes(x = race, y = avg_per_capita_disciplines, fill = race)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ discipline_type, scales = "free_x") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Average Per Capita Discipline by Race and Discipline Type",
       x = "Race",
       y = "Average Per Capita Discipline",
       fill = "Race")
print(per_capita_statewide_graph)
ggsave("per_capita_statwide_graph.png", plot=per_capita_statewide_graph)

length_sw_in_school_suspensions <- in_school_suspensions |> select(race, discipline_type, avg_length)
print(length_sw_in_school_suspensions)
length_sw_oos <- oos |> select(race, discipline_type, avg_length)
print(length_sw_oos)
length_sw_oos_cdap <- out_of_school_cdap_suspensions |>  select(race, discipline_type, avg_length)
print(length_sw_oos_cdap)
length_sw_oos_wo_cdap <- out_of_school_wo_cdap_suspensions |>  select(race, discipline_type, avg_length)
print(length_sw_oos_wo_cdap)
length_sw_expulsions <- expulsions |> select(race, discipline_type, avg_length)
print(length_sw_expulsions)

length_sw <- length_sw_in_school_suspensions |> 
    full_join(length_sw_oos) |> 
    full_join(length_sw_oos_cdap) |> 
    full_join(length_sw_oos_wo_cdap) |> 
    full_join(length_sw_expulsions)

length_sw_graph <- ggplot(length_sw, aes(x=race, y=avg_length, fill=avg_length)) +
    geom_bar(stat= "identity", position="dodge") +
    facet_wrap(~ discipline_type, scales = "free_x") +
    labs(title = "Black students are disciplined for longer than other students.",
         x = "Race",
         y = "Average length of suspension", 
         fill = "Average Length") + # Corrected to set the legend title
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(length_sw_graph)
ggsave("length_sw_graph.png", plot = length_sw_graph)
```

``` {r}
process_race_data <- function(pop_df, discipline_df, dis_code, race_name, grade_query, gender_query, disc_type) {
    library(stringr)
    library(tidyverse)

    filter_incidents <- function(.data, dis_code, race_name = NULL, grade_query = NULL, gender_query = NULL, disc_type = NULL) {
    # Start with filtering district_code as it's applied regardless
    filtered <- .data |> 
        filter(district_code == dis_code) 
    
    # Apply filter for race_name. Default to "All Students" if "all" or NULL
    if (is.null(race_name) || tolower(race_name) == "all") {
        filtered <- filtered |>  filter(race == "All Students")
    } else {
        filtered <- filtered |> filter(race == race_name) |> filter(sub_group == race_name)
    }
    
    # Apply filter for grade_query. Use str_detect for partial matches. Default to "All Students" if "all" or NULL
    if (is.null(grade_query) || tolower(grade_query) == "all") {
        filtered <- filtered |>  filter(grade == "All Students")
    } else {
        filtered <- filtered |>  filter(str_detect(grade, regex(grade_query, ignore_case = TRUE)))
    }
    
    # Apply filter for gender_query. Default to "All Students" if "all" or NULL
    if (is.null(gender_query) || tolower(gender_query) == "all") {
        filtered <- filtered |> filter(gender == "All Students")
    } else {
        filtered <- filtered |> filter(gender == gender_query)
    }

    # Apply filter for disc_type if provided and not "all". No "All Students" default for discipline type as it doesn't apply
    if (!is.null(disc_type) && tolower(disc_type) != "all") {
        filtered <- filtered |> filter(category == disc_type)
    } 
    
    filtered <- filtered |> 
    summarize(num_incidents=median(na.omit(incidents)), num_disc_students=median(na.omit(students)))

    return(filtered)
    }

length_of_discipline <- function(.data, dis_code, race_name = NULL, grade_query = NULL, gender_query = NULL, disc_type = NULL) {
    # Start with filtering district_code as it's applied regardless
    filtered <- .data |> 
        filter(district_code == dis_code) 
    
    # Apply filter for race_name. Default to "All Students" if "all" or NULL
    if (is.null(race_name) || tolower(race_name) == "all") {
        filtered <- filtered |>  filter(race == "All Students")
    } else {
        filtered <- filtered |> filter(race == race_name) |> filter(sub_group == race_name)
    }
    # Apply filter for grade_query. Use str_detect for partial matches. Default to "All Students" if "all" or NULL
    if (is.null(grade_query) || tolower(grade_query) == "all") {
        filtered <- filtered |>  filter(grade == "All Students")
    } else {
        filtered <- filtered |>  filter(str_detect(grade, regex(grade_query, ignore_case = TRUE)))
    }
    # Apply filter for gender_query. Default to "All Students" if "all" or NULL
    if (is.null(gender_query) || tolower(gender_query) == "all") {
        filtered <- filtered |> filter(gender == "All Students")
    } else {
        filtered <- filtered |> filter(gender == gender_query)
    }
    # Apply filter for disc_type if provided and not "all". No "All Students" default for discipline type as it doesn't apply
    if (!is.null(disc_type) && tolower(disc_type) != "all") {
        filtered <- filtered |> filter(category == disc_type)
    } 
    filtered <- filtered |> 
    summarize(avg_length=median(na.omit(avg_duration)))
    return(filtered)
}
    
# this function finds the average number of students of a certain race
find_num_race <- function(.data, dis_code, race_name = NULL, grade_query = NULL, gender_query = NULL, disc_type = NULL) { 
        filtered <- .data |> # .data takes the population dataframe
            filter(district_code== dis_code)
    if (is.null(race_name) || tolower(race_name) == "all") {
        filtered <- filtered |> filter(race == "All Students")
    } else {
        filtered <- filtered |> filter(race == race_name) |> filter(sub_group == race_name)
    }
        if (is.null(grade_query) || tolower(grade_query) == "all") {
        filtered <- filtered |>  filter(grade == "All Students")
    } else {
        filtered <- filtered |>  filter(str_detect(grade, regex(grade_query, ignore_case = TRUE)))
    }
        if (is.null(gender_query) || tolower(gender_query) == "all") {
        filtered <- filtered |>  filter(gender == "All Students")
    } else {
        filtered <- filtered |>  filter(gender == gender_query)
    }

    filtered <- filtered |> 
        filter(is.na(school_year)) # |> 
                    # select(students)
            return(filtered)
        }

    num_race <- find_num_race(pop_df, dis_code, race_name, grade_query, gender_query)
    # this function calculates the average number of incidents per race
    incidents_per_race <- filter_incidents(discipline_df, dis_code, race_name, grade_query, gender_query, disc_type)
    # this function calculates the average length of a discipline measure
    discipline_length <- length_of_discipline(discipline_df, dis_code, race_name, grade_query, gender_query, disc_type)
    # this joins the dataframes into one
    incidents_per_race$num_students <- num_race$students
    incidents_per_race$length <- discipline_length$avg_length
    # this changes the order of the columns
    incidents_per_race <- relocate(incidents_per_race, num_students, .before = 1)
    # this calculates the per capita rate
    incidents_per_race <- incidents_per_race |> 
        mutate(per_capita = as.numeric(num_incidents) / as.numeric(num_students))
}
```

Now, on to the different districts.
``` {r}
results <- list()  # Initialize an empty list to store results
race_names <- c("Hispanic/Latino", "White", "Native American", "African American", "Asian American", "Multi-Racial", "Native Hawaiian/Pacific Islander")
district_codes <- unique(delaware_discipline$district_code)  # Add your actual district codes

for(race in race_names) {
    print(race)
  result <- process_race_data(delaware_pop_copy, delaware_discipline, 72, race, grade_query = NULL, gender_query = NULL, disc_type = NULL)
  results[[race]] <- result  # Store the result with the race name as the key
}
asian_american_results <- results[["Asian American"]]
print(asian_american_results)
# the results here for example are NA - if you open that in excel and type in the same parameters, you will see that the 'students' column is empty - it's all redacted. that's the case with many other school districts. so a county-by-county analysis is impossible, unfortunately.

# Assuming these are your vectors of district codes and race names
pop_df <- delaware_pop_copy
discipline_df <- delaware_discipline

# Function to process each district and race combination
process_data_for_district_and_race <- function(pop_df, discipline_df, dis_code, race_name) {
  process_race_data(pop_df, discipline_df, dis_code, race_name, grade_query, gender_query, disc_type)
}

# Nested lapply to iterate over districts and races
results <- lapply(district_codes, function(dis_code) {
  lapply(race_names, function(race_name) {
    process_data_for_district_and_race(dis_code, race_name)
  })
})

# Optionally, set names for easier navigation
names(results) <- district_codes
for(i in seq_along(results)) {
  names(results[[i]]) <- race_names
}

```